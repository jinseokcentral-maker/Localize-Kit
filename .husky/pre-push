
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üß™ Running tests before push (concurrent)..."
echo ""

# Get the repository root directory
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT" || exit 1

# Create temporary log files
FRONTEND_LOG="/tmp/frontend-test-$$.log"
BACKEND_LOG="/tmp/backend-test-$$.log"

# ANSI color codes
BLUE='\033[0;34m'
GREEN='\033[0;32m'
RESET='\033[0m'

# Function to prefix output with colored [Frontend] or [Backend]
prefix_output() {
  local prefix="$1"
  local color="$2"
  while IFS= read -r line; do
    echo "${color}[$prefix]${RESET} $line"
  done
}

# Run frontend and backend tests concurrently
echo "üì¶ Starting frontend and backend tests..."
echo ""

# Frontend test with blue prefixed output
(cd "$REPO_ROOT/frontend" && pnpm run test -- --run 2>&1 | prefix_output "Frontend" "$BLUE" | tee "$FRONTEND_LOG") &
FRONTEND_PID=$!

# Backend test with green prefixed output
(cd "$REPO_ROOT/backend" && pnpm run test 2>&1 | prefix_output "Backend" "$GREEN" | tee "$BACKEND_LOG") &
BACKEND_PID=$!

# Wait for both tests to complete
wait $FRONTEND_PID
FRONTEND_EXIT=$?

wait $BACKEND_PID
BACKEND_EXIT=$?

# Cleanup log files
rm -f "$FRONTEND_LOG" "$BACKEND_LOG"

# Check results
FAILED=false

if [ $FRONTEND_EXIT -ne 0 ]; then
  echo ""
  echo "‚ùå Frontend tests failed (exit code: $FRONTEND_EXIT)"
  FAILED=true
fi

if [ $BACKEND_EXIT -ne 0 ]; then
  echo ""
  echo "‚ùå Backend tests failed (exit code: $BACKEND_EXIT)"
  FAILED=true
fi

if [ "$FAILED" = true ]; then
  echo ""
  echo "‚ùå Some tests failed. Push aborted."
  exit 1
fi

echo ""
echo "‚úÖ All tests passed! Pushing..."
exit 0


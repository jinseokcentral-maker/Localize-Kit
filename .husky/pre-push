
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üß™ Running tests before push (concurrent)..."
echo ""

# Get the repository root directory
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT" || exit 1

# Create temporary files for exit codes and logs
FRONTEND_EXIT_FILE="/tmp/frontend-exit-$$.tmp"
BACKEND_EXIT_FILE="/tmp/backend-exit-$$.tmp"
FRONTEND_LOG="/tmp/frontend-test-$$.log"
BACKEND_LOG="/tmp/backend-test-$$.log"

# ANSI color codes
BLUE='\033[0;34m'
GREEN='\033[0;32m'
RESET='\033[0m'

# Function to prefix output with colored [Frontend] or [Backend]
prefix_output() {
  local prefix="$1"
  local color="$2"
  while IFS= read -r line; do
    echo "${color}[$prefix]${RESET} $line"
  done
}

# Run frontend and backend tests concurrently
echo "üì¶ Starting frontend and backend tests..."
echo ""

# Frontend test with blue prefixed output
(
  cd "$REPO_ROOT/frontend" && \
  pnpm run test -- --run > "$FRONTEND_LOG" 2>&1
  TEST_EXIT=$?
  prefix_output "Frontend" "$BLUE" < "$FRONTEND_LOG"
  echo $TEST_EXIT > "$FRONTEND_EXIT_FILE"
) &
FRONTEND_PID=$!

# Backend test with green prefixed output
(
  cd "$REPO_ROOT/backend" && \
  pnpm run test > "$BACKEND_LOG" 2>&1
  TEST_EXIT=$?
  prefix_output "Backend" "$GREEN" < "$BACKEND_LOG"
  echo $TEST_EXIT > "$BACKEND_EXIT_FILE"
) &
BACKEND_PID=$!

# Wait for both tests to complete
wait $FRONTEND_PID
wait $BACKEND_PID

# Read exit codes from files
FRONTEND_EXIT=$(cat "$FRONTEND_EXIT_FILE" 2>/dev/null || echo "1")
BACKEND_EXIT=$(cat "$BACKEND_EXIT_FILE" 2>/dev/null || echo "1")

# Cleanup temporary files
rm -f "$FRONTEND_EXIT_FILE" "$BACKEND_EXIT_FILE" "$FRONTEND_LOG" "$BACKEND_LOG"

# Check results
FAILED=false

if [ "$FRONTEND_EXIT" -ne 0 ]; then
  echo ""
  echo "‚ùå Frontend tests failed (exit code: $FRONTEND_EXIT)"
  FAILED=true
fi

if [ "$BACKEND_EXIT" -ne 0 ]; then
  echo ""
  echo "‚ùå Backend tests failed (exit code: $BACKEND_EXIT)"
  FAILED=true
fi

if [ "$FAILED" = true ]; then
  echo ""
  echo "‚ùå Some tests failed. Push aborted."
  exit 1
fi

echo ""
echo "‚úÖ All tests passed! Pushing..."
exit 0

